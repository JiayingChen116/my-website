---
categories:
- ""
- ""
date: "2017-10-31T21:28:43-05:00"
description: In this project, I took the challenge to take a further look into how the percentage of GDP compositions change over time among different countries and gain insights about diversity of economy.
draft: false
image: ""
keywords: ""
slug: ipsum
title: Project 3 GDP Global Comparison 
---

```{r, setup, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```

```{r load-libraries, echo=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(GGally)
library(readxl)
library(here)
library(skimr)
library(janitor)
library(broom)
library(tidyquant)
library(infer)
library(openintro)
library(RSQLite)
library(dbplyr)
library(DBI)
library(janitor)
library(knitr)
library(scales)
```

# Youth Risk Behavior Surveillance

Every two years, the Centers for Disease Control and Prevention conduct the [Youth Risk Behavior Surveillance System (YRBSS)](https://www.cdc.gov/healthyyouth/data/yrbs/index.htm) survey, where it takes data from high schoolers (9th through 12th grade), to analyze health patterns. You will work with a selected group of variables from a random sample of observations during one of the years the YRBSS was conducted.

## Load the data

This data is part of the `openintro` textbook and we can load and inspect it. There are observations on 13 different variables, some categorical and some numerical. The meaning of each variable can be found by bringing up the help file:

?yrbss

```{r}
data(yrbss)
glimpse(yrbss)
```

Before you carry on with your analysis, it's is always a good idea to check with `skimr::skim()` to get a feel for missing values, summary statistics of numerical variables, and a very rough histogram.

```{r}
skim(yrbss)
```

## Exploratory Data Analysis

You will first start with analyzing the `weight` of participants in kilograms. Using visualization and summary statistics, describe the distribution of weights. How many observations are we missing weights from?

*From the histogram below we can observe that the distribution of weight is right-skewed - most people remain within the 50 to 80kg while there are several individuals that go above that, forming the right tail. It is important to note that we are missing 1004 weight and height measurements, which we can observe from the `n_missing` statistic*

```{r, eda_on_weight, warning = FALSE, results='hide',fig.keep='all', fig.width = 11, fig.height = 9}
weight_hist <- ggplot(yrbss, aes(x = weight, fill = gender))+
  geom_histogram(bins = 50)+
  
  geom_vline(aes(xintercept = median(weight)), linetype = 2)+
  
  labs(title = "Distribution of weight", subtitle = "Youth Risk Behaviour Surveillence Dataset Analysis",  x = "Weight (kg)", y = "Count")
  
  theme_stata()+
  theme(plot.background = element_blank())

weight_hist

```

Next, consider the possible relationship between a high schooler's weight and their physical activity. Plotting the data is a useful first step because it helps us quickly visualize trends, identify strong associations, and develop research questions.

```{r weight_physActivity,  warning = FALSE, fig.width = 11}

weight_physAct <- ggplot(na.omit(yrbss), aes(x = as.factor(physically_active_7d), y = weight))+
  geom_boxplot(fill="red", alpha=0.2)+
  stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="brown")+
  labs(title = "High Schoolers: Weight and Physical Activity", subtitle = "Boxplot showing relationship between weight and number of days of physical activity per week", x = "Number of days of physical activity per week", y = "Weight (Kg)")
  NULL

weight_physAct

```

Let's create a new variable in the dataframe `yrbss`, called `physical_3plus` , which will be `yes` if they are physically active for at least 3 days a week, and `no` otherwise. You may also want to calculate the number and % of those who are and are not active for more than 3 days. Use the `count()` function and see if you get the same results as `group_by()... summarise()`

```{r, mutate_and_count,  warning = FALSE, fig.width = 11}
# Create physical_3plus variable
yrbss_adj <- yrbss %>% 
  mutate(physical_3plus = if_else(physically_active_7d >= 3, "Yes", "No")) # Create physical_3plus variable
yrbss_adj

# Proportion using group_by and summarise
proportion_weight <- yrbss_adj %>% 
  group_by(physical_3plus) %>% 
  summarise(n = sum(!is.na(physical_3plus))) %>% # Omit NA values
  mutate(prop_perc = n/sum(n)*100)
proportion_weight

# Proportion using count method
num_yes <- count(yrbss_adj$physical_3plus == "Yes") # Count number of people physically active >3 days a week
num_no <- count(yrbss_adj$physical_3plus == "No") # Count number of people physically active <3 days a week
num_total = (num_yes+num_no)
perc_yes = num_yes/num_total*100
perc_no = num_no/num_total*100
count_method_df <- tibble(values = 
                          c("Yes", "No", "Total"), 
                          count = c(num_no, num_yes, num_total), 
                          prop_perc = c(perc_no, perc_yes, 100))
count_method_df

```

Can you provide a 95% confidence interval for the population proportion of high schools that are *NOT* active 3 or more days per week?

```{r, CI_proportion_notactive3days, fig.width=11, warning = FALSE, }

Notactive_3daysormore <-  prop.test(as.double(count_method_df[1,"count"]), as.double(count_method_df[3,"count"])) # Create test to obtain 95% CI interval

Notactive_3daysormore

```

*The confidence interval for the proportion of high schoolers that are active for at least 3 days a week based on out sample ranges from 32.3% to 33.9%*

Make a boxplot of `physical_3plus` vs. `weight`. Is there a relationship between these two variables? What did you expect and why?

*There does not seem to be a clear relationship between both variables. Initially, one can expect that people who exercise more (3 or more days a week) would be more in shape and therefore weight less. However, from the boxplot it is observed that this is not true, as for this dataset people who exercise 3 or more days weights more than the ones who don't. Weight can be influenced by many other aspects, such as height, nutrition and muscle mass, hence the initial hypothesis of a negative relationship between weight and physical activity can be discarded.*

```{r, boxplot_activity_weight, fig.width=11, fig.height=9}
boxplot_activity_weight <- yrbss_adj %>%
  filter(is.na(physical_3plus) == FALSE ) %>% # Omit NA values
  ggplot()+
  geom_boxplot(aes(x = physical_3plus, y = weight), fill="red", alpha=0.2)+
  labs(title = "High Schoolers: Weight and Physical Activity", subtitle = "Boxplot showing relationship between weight and people who exercise more or less than 3 days a week", x = "Physically active 3 or more days a week", y = "Weight (Kg)")+
  theme_bw()+
  NULL

boxplot_activity_weight


```

## Confidence Interval

Boxplots show how the medians of the two distributions compare, but we can also compare the means of the distributions using either a confidence interval or a hypothesis test. Note that when we calculate the mean, SD, etc. weight in these groups using the mean function, we must ignore any missing values by setting the `na.rm = TRUE`.

```{r, ci_using_formulas, fig.width=11, warning = FALSE}

means_weight <- yrbss_adj %>% 
  filter(is.na(physical_3plus) == FALSE ) %>% # Omit NA values
  group_by(physical_3plus) %>% 
  summarise(n = n(), mean_group = mean(weight, na.rm = TRUE), SD = sd(weight, na.rm = TRUE), SE = SD/sqrt(n), t_crit = qt(0.975, n - 1), lower_lim = mean_group - t_crit*SE, upper_lim = mean_group + t_crit*SE)
  
means_weight

```

*There is an observed difference of about 1.7kg (68.4 - 66.7), and we notice that the two confidence intervals do not overlap. It seems that the difference is at least 95% statistically significant. Let us also conduct a hypothesis test.*

## Hypothesis test with formula

Write the null and alternative hypotheses for testing whether mean weights are different for those who exercise at least 3? times a week and those who don't.

*Claim (Null hypothesis):* $H0: \delta = 0$\* *There is no difference in means across the groups*

*Alternative hypothesis:* $H_a: \delta$\* *There is a difference in means across the groups*

*We test the difference between means of the two directors, and the t-stat value equals 3 (greater than t-critical), while the p-value is 0.01 (\>5%). The confidence interval is [0.16,1.13] and does not contain the value 0. Therefore, we reject H0 and can conclude that the mean ratings of Spielberg and Burton are significantly different.*

```{r, t_test_using_R, fig.width=11, warning = FALSE}

t.test(weight ~ physical_3plus, data = yrbss_adj)

```

## Hypothesis test with `infer`

Next, we will introduce a new function, `hypothesize`, that falls into the infer workflow. You will use this method for conducting hypothesis tests.

But first, we need to initialize the test, which we will save as `obs_diff`.

```{r, calc_obs_difference, fig.width=11, warning = FALSE}
obs_diff <- yrbss_adj %>%
  specify(weight ~ physical_3plus) %>%
  calculate(stat = "diff in means", order = c("Yes", "No"))

obs_diff

```

Notice how you can use the functions specify and calculate again like you did for calculating confidence intervals. Here, though, the statistic you are searching for is the difference in means, with the order being yes - no != 0 (Alternative).

After you have initialized the test, you need to simulate the test on the null distribution, which we will save as null.

```{r, hypothesis_testing_using_infer_package, fig.width=11, warning = FALSE}

null_dist <- yrbss_adj %>%
  # specify variables
  specify(weight ~ physical_3plus) %>%
  
  # assume independence, i.e, there is no difference
  hypothesize(null = "independence") %>%
  
  # generate 1000 reps, of type "permute"
  generate(reps = 1000, type = "permute") %>%
  
  # calculate statistic of difference, namely "diff in means"
  calculate(stat = "diff in means", order = c("Yes", "No"))

null_dist

```

Here, `hypothesize` is used to set the null hypothesis as a test for independence, i.e., that there is no difference between the two population means. In one sample cases, the null argument can be set to *point* to test a hypothesis relative to a point estimate.

Also, note that the `type` argument within generate is set to permute, which is the argument when generating a null distribution for a hypothesis test.

We can visualize this null distribution with the following code:

```{r, fig.width=11, warning = FALSE}
ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram()+
  theme_bw()

```

Now that the test is initialized and the null distribution formed, we can visualise to see how many of these null permutations have a difference of at least `obs_stat` of `r obs_diff %>% pull() %>% round(2)`?

```{r, fig.width=11, warning = FALSE}
obs_stat <- obs_diff %>% pull() %>% round(2)
obs_stat

```

We can also calculate the p-value for your hypothesis test using the function `infer::get_p_value()`.

```{r, fig.width=11, warning = FALSE}

null_dist %>% visualize() +
  shade_p_value(obs_stat = obs_diff, direction = "two-sided")+
  theme_bw()

null_dist %>%
  get_p_value(obs_stat = obs_diff, direction = "two_sided")

```

This the standard workflow for performing hypothesis tests.

# IMDB ratings: Differences between directors

Recall the IMBD ratings data. I would like you to explore whether the mean IMDB rating for Steven Spielberg and Tim Burton are the same or not. I have already calculated the confidence intervals for the mean ratings of these two directors and as you can see they overlap.

```{r load-movies-data, fig.width=11, warning = FALSE}
movies <- read_csv(here::here("data", "movies.csv"))
glimpse(movies)

```

```{r, burton_spielberg confidence interval, fig.width=11, warning = FALSE}
burton_spielberg <- movies %>% 
  filter(director %in% c("Steven Spielberg", "Tim Burton")) %>% 
  group_by(director) %>% 
  summarise(mean=mean(rating),
            count=n(),
            t_critical = qt(0.975, count-1),
            se = sd(rating)/sqrt(count),
            margin_of_error = t_critical*se,
            lower_ci = mean - margin_of_error,
            higher_ci = mean + margin_of_error)
burton_spielberg
  
```

```{r, replicating the plot, fig.width=11, warning = FALSE}
plot <- ggplot(burton_spielberg, aes(x=mean, y=reorder(director, mean), colour = director))+
  geom_errorbar(width = 0.05, aes(xmin = lower_ci, xmax = higher_ci), size = 2)+
  geom_point(aes(x=mean), size = 5)+
  geom_rect(aes(xmin = max(lower_ci), xmax = min(higher_ci), ymin = Inf, ymax = Inf),
            fill="gray", colour="gray",alpha = 0.3)+
  theme_bw() +
  geom_text(aes(x=mean, label = round(mean, digits=2)),
            size = 8, vjust = 2, color = "black")+
  geom_text(aes(x=lower_ci, label=round(lower_ci,digits=2)),
            size = 6, vjust = 2, color = "black")+
  geom_text(aes(x=higher_ci, label=round(higher_ci,digits=2)),
            size = 6, vjust = 2, colour = "black")+
  labs(title = "Do Spielberg ad Burton have the same IMDB ratings?", 
       subtitle = "95% confidence intervals overlap", x="Mean IMDB Rating", y="")+
  theme(plot.title=element_text(size=12,face="bold"),
        axis.text = element_text(size=10),
        legend.position = "none")
plot
  
```

*Null Hypothesis H0: Average Rating for Spielberg - Average Rating for Burton = 0* *Alternative Hypothesis H1: Difference in Means not equal to 0.*

```{r, fig.width=11, warning = FALSE}
testrating <- movies %>% 
  filter(director %in% c("Steven Spielberg", "Tim Burton")) %>% 
  select(director, rating)

t.test(testrating$rating ~ testrating$director)
```

*We test the difference between means of the two directors, and the t-stat value equals 3 while the p-value is 0.01. The confidence interval is [0.16,1.13] and does not contain the value 0. The t-statistics value is greater than 2, p-value \< 5% and 0 lies outside the confidence interval, therefore we reject H0.*

```{r, fig.width=11, warning = FALSE}
obs_diff1 <- testrating %>%
  specify(rating ~ director) %>%
  calculate(stat = "diff in means", order = c("Steven Spielberg", "Tim Burton"))
obs_diff1
```

```{r, fig.width=11, warning = FALSE}
null_dist1 <- testrating %>%
  # specify variables
  specify(rating ~ director) %>%
  
  # assume independence, i.e, there is no difference
  hypothesize(null = "independence") %>%
  
  # generate 1000 reps, of type "permute"
  generate(reps = 1000, type = "permute") %>%
  
  # calculate statistic of difference, namely "diff in means"
  calculate(stat = "diff in means", order = c("Steven Spielberg", "Tim Burton"))

null_dist1

```

```{r, fig.width=11, warning = FALSE}
ggplot(data = null_dist1, aes(x = stat)) +
  geom_histogram()+
  theme_bw()

```

```{r, fig.width=11, warning = FALSE}
obs_stat1 <- obs_diff1 %>% pull() %>% round(2)
obs_stat1
```

```{r, fig.width=11, warning = FALSE}
null_dist1 %>% visualize() +
  shade_p_value(obs_stat = obs_diff1, direction = "two-sided")+
  theme_bw()

null_dist1 %>%
  get_p_value(obs_stat = obs_diff1, direction = "two_sided")
```

# Omega Group plc- Pay Discrimination

At the last board meeting of Omega Group Plc., the headquarters of a large multinational company, the issue was raised that women were being discriminated in the company, in the sense that the salaries were not the same for male and female executives. A quick analysis of a sample of 50 employees (of which 24 men and 26 women) revealed that the average salary for men was about 8,700 higher than for women. This seemed like a considerable difference, so it was decided that a further analysis of the company salaries was warranted.

You are asked to carry out the analysis. The objective is to find out whether there is indeed a significant difference between the salaries of men and women, and whether the difference is due to discrimination or whether it is based on another, possibly valid, determining factor.

## Loading the data

```{r load_omega_data, fig.width=11, warning = FALSE}
omega <- read_csv(here::here("data", "omega.csv"))
glimpse(omega) # examine the data frame
```

## Relationship (Salary - Gender)

The data frame `omega` contains the salaries for the sample of 50 executives in the company. Can you conclude that there is a significant difference between the salaries of the male and female executives?

*We will be performing two analyses - (1) Confidence Intervals and (2) Hypothesis Testing, and see if both lead to the same conclusion.*

### Two Separate Confidence Intervals

```{r, confint_single_variables_salary, warning = FALSE, results='hide',fig.keep='all', fig.width = 11, fig.height = 9}
# Summary Statistics of salary by gender
mosaic::favstats (salary ~ gender, data=omega)

# Dataframe with two rows (male-female) and having as columns gender, mean, SD, sample size, the t-critical value, the standard error, the margin of error, and the low/high endpoints of a 95% condifence interval
formula_ci_salary <- omega %>% 
  group_by(gender) %>% 
  summarise(mean_salary = mean(salary),
            sd_salary = sd(salary),
            count = n(),
            
            # get t-critical value with (n-1) degrees of freedom
            t_critical = qt(0.975, count-1),
            se = sd_salary/sqrt(count),
            margin_of_error = t_critical * se,
            ci_low = mean_salary - margin_of_error,
            ci_high = mean_salary + margin_of_error
            ) 

formula_ci_salary
```

```{r visualise_ci_salary, warning = FALSE, results='hide',fig.keep='all', fig.width = 11, fig.height = 9}

ggplot(formula_ci_salary, 
       aes(x=mean_salary,
           y=gender,
           colour=gender)) +   
  geom_point() +
  scale_colour_manual(values = c("red","blue")) +
  geom_errorbar(width=.2, aes(xmax = ci_high, xmin = ci_low)) +
  
  scale_x_continuous(labels = number)
  
  theme_bw() +
  labs(title = "Which gender has a higher salary?", 
       x = "Mean salary", 
       y = "Gender") +
  NULL

```

*Interpretation: In this analysis, we compared the confidence intervals for the mean salaries of men and women to determine whether the difference between the two means is statistically significant. Based on our analysis, the mean salary for women is `64543`, but it can be anywhere between `61486` and `67599`. On the other hand, the mean salary for men is `73239`, but it can be anywhere between `70088` and `76390`. When visualising the two confidence intervals, we can also see that the two does not overlap. Hence, we can conclude that there is a significant difference between the salaries of the men and women executives, where women has a lower average salary than men.*

### Hypothesis Testing

*To perform a hypothesis testing, we assume the null hypothesis (H~0~) that there is no difference in mean salary between men and women (difference is zero), and the alternative Hypothesis (H~a~) that there is a difference in mean salary between men and women (difference is non-zero).*

*We will be performing our hypothesis testing using `t.test()` and with the simulation method from the `infer` package.*

#### `t.test()`

```{r, hypothesis_testing_ttest_salary, fig.width=11, warning = FALSE}

mosaic::favstats(salary ~ gender, data = omega)
t.test(salary ~ gender, data = omega)

```

*Interpretation: When running the hypothesis test using `t.test()`, we get a t-stat value of -4, which is greater than the 5% critical value of 1.96. Another way to look at it is that the CI for the difference between the two means is `[-12973, -4420]` which does not contains zero. Hence, we can reject the null hypothesis and conclude that there is a significant difference between the salaries of male and female executives*.

#### Simulation Method (`infer` package)

```{r, hypothesis_testing_infer_salary, warning = FALSE, results='hide',fig.keep='all', fig.width = 11, fig.height = 9}

set.seed(1234)

# calculate the observed statistic
observed_statistic_salary <- omega %>%  
  specify(salary ~ gender) %>% 
  calculate(stat = "diff in means",
            order = c("male", "female"))

observed_statistic_salary

# generate the null distribution with randomisation
diff_salary_null_world <- omega %>% 
  specify(salary ~ gender) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "diff in means",
  order = c("male", "female"))

# visualise the randomisation-based null distribution and test statistic
diff_salary_null_world %>% 
  visualize() +
  theme_bw()+
  shade_p_value(observed_statistic_salary, direction = "two-sided") +
  scale_x_continuous(labels = number)
  theme_bw() + 
  labs(title = "Differences in mean salaries between male and female in a hypothetical null world",
       subtitle = "Red line shows observed difference in mean salaries",
       x = "Difference in mean salaries\n(Male - Female)",
       y = "Count") 
  

# calculate the p value from the randomisation-based null distribution and the observed statistic
p_value_salary <- diff_salary_null_world %>%
  get_pvalue(obs_stat = observed_statistic_salary,
              direction = "two-sided")

p_value_salary

```

*Interpretation: Based on our hypothesis testing using the infer package, we get a p-value of close to 0. This means that there's a close to 0% chance of seeing a difference at least as large as 8696 in a world where there's no difference. In other words, given what we observed, the null hypothesis is false and it will be impossible to observed such results if the null hypothesis is true. Hence, we can reject the null world and conclude that there is a significant difference between the salaries of male and female executives.*

### Conclusion

*The results of both analyses, confidence intervals and hypothesis testing, lead to the same conclusion. That is, there is a significant difference between the salaries of the male and female executives.*

## Relationship (Experience - Gender)

At the board meeting, someone raised the issue that there was indeed a substantial difference between male and female salaries, but that this was attributable to other reasons such as differences in experience. A questionnaire send out to the 50 executives in the sample reveals that the average experience of the men is approximately 21 years, whereas the women only have about 7 years experience on average (see table below).

```{r, experience_stats, fig.width=11, warning = FALSE}
# Summary Statistics of experience by gender
favstats (experience ~ gender, data=omega)

```

**Based on this evidence, can you conclude that there is a significant difference between the experience of the male and female executives?**

*We will be performing similar analyses as in the previous section - (1) Confidence Intervals and (2) Hypothesis Testing. Let's see how the conclusion of these analyses validates or endanger our previous conclusion on the difference in male and female salaries.*

### Two Separate Confidence Intervals

```{r, confint_single_variables_experience, fig.width=11, warning = FALSE}

formula_ci_experience <- omega %>% 
  group_by(gender) %>% 
  summarise(mean_experience = mean(experience),
            sd_experience = sd(experience),
            count = n(),
            
            # get t-critical value with (n-1) degrees of freedom
            t_critical = qt(0.975, count-1),
            se = sd_experience/sqrt(count),
            margin_of_error = t_critical * se,
            ci_low = mean_experience - margin_of_error,
            ci_high = mean_experience + margin_of_error
            ) 

formula_ci_experience

```

```{r visualise_ci_experience, fig.width=11, warning = FALSE}

ggplot(formula_ci_experience, 
       aes(x=mean_experience,
           y=gender,
           colour=gender)) +   
  geom_point() +
  scale_colour_manual(values = c("red","blue")) +
  geom_errorbar(width=.2, aes(xmax = ci_high, xmin = ci_low)) +
  theme_bw() +
  labs(title = "Which gender has more years of experience?", 
       x = "Average years of experience", 
       y = "Gender") +
  NULL

```

*Interpretation: In this analysis, we compared the confidence intervals for the average years of experience of men and women to determine whether the difference between the two means is statistically significant. Based on our analysis, the average years of experience for women is around `7 years`, but it can be anywhere between `3.95` and `10.8 years`. On the other hand, the average years of experience for men is around `21 years`, but it can be anywhere between `16.52` and `25.7 years`. When visualising the two confidence intervals, we can also see that the two does not overlap. Hence, we can conclude that there is a significant difference between the experience of the male and female executives, where females have less experience than males.*

### Hypothesis Testing

*To perform a hypothesis testing, we assume the null hypothesis (H~0~) that there is no difference in average experience between men and women (difference is zero), and the alternative Hypothesis (H~a~) that there is a difference in average experience between men and women (difference is non-zero).*

*We will be performing our hypothesis testing using `t.test()` and with the simulation method from the `infer` package.*

#### `t.test()`

```{r, hypothesis_testing_ttest_experience, fig.width=11, warning = FALSE}

mosaic::favstats(experience ~ gender, data = omega)
t.test(experience ~ gender, data = omega)

```

*Interpretation: When running the hypothesis test using `t.test()`, we get a t-stat value of -5, which is greater than the 5% critical value of 1.96. Another way to look at it is that the CI for the difference between the two means is [7.38, 21.12] which does not contains zero. Hence, we can reject the null hypothesis and conclude that there is a significant difference between the experience of the male and female executives.*

#### Simulation Method (`infer` package)

```{r, hypothesis_testing_infer_experience, fig.width=11, warning = FALSE}

set.seed(1234)

# calculate the observed statistic
observed_statistic_experience <- omega %>%  
  specify(experience ~ gender) %>% 
  calculate(stat = "diff in means",
            order = c("male", "female"))

observed_statistic_experience

# generate the null distribution with randomisation
diff_experience_null_world <- omega %>% 
  specify(experience ~ gender) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "diff in means",
  order = c("male", "female"))

# visualize the randomisation-based null distribution and test statistic
diff_experience_null_world %>% 
  visualize() +
  shade_p_value(observed_statistic_experience, direction = "two-sided") +
  theme_bw() + 
  labs(title = "Differences in experience between male and female in a hypothetical null world",
       subtitle = "Red line shows observed difference in average experience",
       x = "Difference in average experience\n(Male - Female)",
       y = "Count") 
  

# calculate the p value from the randomisation-based null distribution and the observed statistic
p_value_experience <- diff_experience_null_world %>%
  get_pvalue(obs_stat = observed_statistic_experience,
              direction = "two-sided")

p_value_experience

```

*Interpretation: Based on our hypothesis testing using the infer package, we get a p-value of close to 0. This means that there's a close to 0% chance of seeing a difference at least as large as 13.7 years in a world where there's no difference. In other words, given what we observed, the null hypothesis is false and it will be impossible to observed such results if the null hypothesis is true. Hence, we can reject the null world and conclude that there is a significant difference between the experience of the male and female executives.*

### Conclusion

*The results of both analyses, confidence intervals and hypothesis testing, lead to the same conclusion. That is there is a significant difference between the experience of the male and female executives.*

## Relationship (Salary - Experience)

Someone at the meeting argues that clearly, a more thorough analysis of the relationship between salary and experience is required before any conclusion can be drawn about whether there is any gender-based salary discrimination in the company.

**Analyse the relationship between salary and experience. Draw a scatter plot to visually inspect the data.**

### Salary vs Experience Scatter Plot

```{r, salary_exp_scatter, fig.width=11, warning = FALSE}

# Calculating Pearson's product-moment correlation
cor.test(omega$experience, omega$salary, method = "pearson", conf.level = 0.95)

ggplot(omega, aes(x = experience, y = salary)) +
  geom_point() +
  geom_smooth(method = lm, col = "red") +
  labs(title = "The relationship between salary and experience", 
       x = "Years of experience",
       y = "Salary") + 
  theme_bw() +
  annotate("text", x = 7, y = 85000, col = "red", size = 3,
             label = paste("Pearson r = ", signif(cor(omega$experience, omega$salary),3))) +
  NULL

```

## Check correlations between the data

Using `GGally:ggpairs()` to create a scatter plot and correlation matrix. Essentially, we change the order of our variables will appear in and have the dependent variable (Y), salary, as last in our list. We then pipe the data frame to `ggpairs()` with `aes` arguments to colour by `gender` and make these plots somewhat transparent (`alpha  = 0.3`).

```{r ggpairs, fig.width=12, fig.width=11, warning = FALSE}
omega %>% 
  select(gender, experience, salary) %>% #order variables they will appear in ggpairs()
  ggpairs(aes(colour=gender, alpha = 0.3))+
  theme_bw()
```

**Look at the salary vs experience scatter plot. What can you infer from this plot? Explain in a couple of sentences.**

*Interpretation: Based on our analysis, there is a positive relationship between salary and experience as the correlation coefficient is close to 1. In other words, as years of experience increases, salary increases. When categorizing the gender into different colors, we can see that more women are on the left side of the graph, indicating lesser years of experience on average. Hence, this is a good indication as of why women has a lower average salary as compared to men.*

## Final conclusion

*According to our analysis, there is a positive relationship between salary and experience, and women has lower years of experience than men on average. Hence, the assumption that women were being discriminated in the company in the sense that the salaries were not the same for male and female executives may not be true. The substantial difference between male and female salaries is more likely attributable to differences in experience.*

# Challenge 1: Brexit plot.

```{r load_brexit_data, fig.width=11, warning = FALSE}
brexit_results <- read_csv(here::here("data", "brexit_results.csv"))

```

```{r plot_brexit_data, fig.width=11, warning = FALSE}
adj_brexit_results <- pivot_longer(brexit_results, cols = c("con_2015", "lab_2015", "ld_2015", "ukip_2015"), names_to = "party", values_to = "general_election_2015")

scatter_election_brexit <- ggplot(adj_brexit_results, aes(x = general_election_2015, y = leave_share, color = party))+
  geom_point(size = 0.3)+
  geom_smooth(method = "lm")+
  scale_color_manual(name = "", values = c("#0087DC", "#E4003B", "#FAA61A","#70147A"), labels = c("Conservative", "Labour", "Lib Dems", "UKIP"))+
  
  labs(title = "How political affiliation translated to Brexit voting", x = "Party % in the UK 2015 general election", y = "Leave % in the 2016 Brexit referendum")+
  
  theme_bw()+
  theme(legend.position = "bottom")

scatter_election_brexit
```

# Challenge 3:GDP components over time and among countries

At the risk of oversimplifying things, the main components of gross domestic product, GDP are personal consumption (C), business investment (I), government spending (G) and net exports (exports - imports). You can read more about GDP and the different approaches in calculating at the [Wikipedia GDP page](https://en.wikipedia.org/wiki/Gross_domestic_product).

The GDP data we will look at is from the [United Nations' National Accounts Main Aggregates Database](https://unstats.un.org/unsd/snaama/Downloads), which contains estimates of total GDP and its components for all countries from 1970 to today. We will look at how GDP and its components have changed over time, and compare different countries and how much each component contributes to that country's GDP. The file we will work with is [GDP and its breakdown at constant 2010 prices in US Dollars](http://unstats.un.org/unsd/amaapi/api/file/6) and it has already been saved in the Data directory. Have a look at the Excel file to see how it is structured and organised

```{r read_GDP_data, fig.width=11, warning = FALSE}

UN_GDP_data  <-  read_excel(here::here("data", "Download-GDPconstant-USD-countries.xls"), # Excel filename
                sheet="Download-GDPconstant-USD-countr", # Sheet name
                skip=2) # Number of rows to skip

```

The first thing you need to do is to tidy the data, as it is in wide format and you must make it into long, tidy format. Please express all figures in billions (divide values by `1e9`, or $10^9$), and you want to rename the indicators into something shorter.

```{r reshape_GDP_data, fig.width=11, warning = FALSE}

tidy_GDP_data  <-  UN_GDP_data %>% 
  pivot_longer(cols = 4:51, values_to = "gdp_in_billion", names_to = "years") %>% 
  mutate(gdp_in_billion = gdp_in_billion/10^9)

tidy_GDP_data

glimpse(tidy_GDP_data)
skim(tidy_GDP_data)

# Let us compare GDP components for these 6 countries, including our own countries China, Malaysia and Spain
country_list <- c("United States","Spain","China", "Germany", "India", "Malaysia")

```

```{r, gdp component over time, warning=FALSE, fig.width=12}

indicator_list <- c("Gross capital formation","Imports of goods and services", "General government final consumption expenditure", "Household consumption expenditure (including Non-profit institutions serving households)", "Exports of goods and services")

gdp_plot <-tidy_GDP_data[which(tidy_GDP_data$Country %in% country_list),]
gdp_plot <-gdp_plot[which(gdp_plot$IndicatorName %in% indicator_list),]
  
plot_gdp <- ggplot(gdp_plot, aes(x = as.integer(years),y=gdp_in_billion))+
  geom_line(aes(color = IndicatorName))+
  facet_wrap(vars(Country))+ 
  labs(title = "GDP components over time",subtitle = 'In constant 2010 USD', y = "Billion US$", x= "year")+
  scale_colour_hue("Components of GDP",labels=c("Exports ","Government Expenditure","Gross capital formation","Household Expenditure","Imports"))+
  theme_bw()+
  NULL
plot_gdp

```

Secondly, recall that GDP is the sum of Household Expenditure (Consumption *C*), Gross Capital Formation (business investment *I*), Government Expenditure (G) and Net Exports (exports - imports). Even though there is an indicator `Gross Domestic Product (GDP)` in your dataframe, I would like you to calculate it given its components discussed above.

> What is the % difference between what you calculated as GDP and the GDP figure included in the dataframe?

*gdp_diff is the % difference between the calculated GDP(gdp_sum) and the GDP figure in the dataframe. The mean of gdp_diff is -0.5%, which indicates that the GDP we calculated is slightly lower than the figure given. This is probably because the calculated one is expenditure approach while GDP figure is usually calculated by income approach or production approach. The measurement error in practice made two figures slightly off.*

```{r,compare GDP,warning=FALSE, fig.width=11}
indicator_list2 <- c("Gross capital formation","Imports of goods and services", "General government final consumption expenditure", "Household consumption expenditure (including Non-profit institutions serving households)", "Exports of goods and services", "Gross Domestic Product (GDP)")

gdp_plot <-tidy_GDP_data[which(tidy_GDP_data$Country %in% country_list),]
gdp_plot <-gdp_plot[which(gdp_plot$IndicatorName %in% indicator_list2),]

gdp_plot2<-pivot_wider(gdp_plot,names_from  = IndicatorName, values_from  = gdp_in_billion)

colnames(gdp_plot2)<-c("countryID","country","years","Household_Expenditure","Government_Expenditure","Gross_Capital_Formation","Exports","Imports","gdp_origin") 

 gdp_plot2<-gdp_plot2 %>%
   mutate(Net_Exports = Exports-Imports, gdp_sum=Household_Expenditure +Government_Expenditure+Gross_Capital_Formation+Net_Exports,h_pro=Household_Expenditure/gdp_sum,g_pro=Government_Expenditure/gdp_sum,c_pro=Gross_Capital_Formation/gdp_sum,n_pro= Net_Exports/gdp_sum,gdp_diff=(gdp_sum/gdp_origin)-1)

skim(gdp_plot2)

```

```{r,gdp percent change over time, fig.width=11, warning = FALSE}
 gap_perc_plot <- ggplot(gdp_plot2, aes(x = as.integer(years)))+
                                   facet_wrap(vars(country))+
                          geom_line(aes(y=h_pro,color="#339999"))+
                         geom_line(aes(y=c_pro,color="#00CC00"))+
                         geom_line(aes(y=g_pro,color="#FF3300"))+
                         geom_line(aes(y=n_pro,color="purple"))+
               # theme(panel.border = element_rect(colour = NA, fill=NA))+
                scale_y_continuous(labels = scales::percent)+
                theme_bw()+
   labs(title = "GDP and its breakdown at constant 2010 prices in US Dollars ", y = "proportion", x= "year")+
   scale_color_identity(breaks = c("#339999", "#00CC00", "#FF3300", "purple"),
                        labels = c("Household Expenditure", "Gross capital formation", "Government Expenditure", "Net Exports"),
                        guide = "legend",
                        name = "Legend")+
                NULL

                         
gap_perc_plot 
```

> What is this last chart telling you? Can you explain in a couple of paragraphs the different dynamic among these three countries?

*The last chart has displayed how percentage of investment(capital formation), consumption(household expenditure), net exports and government expenditure among GDP has changed over time for Germany, India and the United States. The patterns are indicating various characteristic of the countries' economy.*

*As for Germany, the largest economy in Europe, the proportion of GDP components is generally stable from 1970 to 2000 with around 60% household expenditure, 20% capital expenditure, 20% government expenditure and 0% net exports. Since 2000, Net Export in Germany has exoerienced a sharp rise while household expenditure gradually fell by 5%. Compared with India and United States, an obvious characteristic of Germany's economy is the trade surplus since 2000, which indicates the economic development is more dependent on international trade.*

*As for India,the fastest growing major economy throughout the world, we can observe a sharp fall in household expenditure since 1970 and a quick rise in capital formation since 2000, which means the engine of economic growth is switching from consumption to investment. Thanks to the broad economic liberalisation in India in 1990s, the growth in investment results from the incredible increase in foreign direct investment, and this finally benefits India's economy.*

*As for the United States, the proportion of consumption and investment are gradually rising while government expenditure and net export are falling. Compared to the other countries, US seems like a consumption-oriented economy with values of around 70%. Since 1990, the US trade deficit has widened. A sudden decrease in 2008-2009 in investment sector might be attributed to the subprime mortgage crisis of the US.*

*We also included our own countries China, Malaysia and Spain.* *For China, unlike the other 5 countries, investment has exceeded consumption in 2004 and become the most important engine of economic growth. Net exports have been over zero since 1990. Trade surplus indicates that international trade makes up a sizeable portion of China's overall economy. Since economic reforms began in the late 1970s, China sought to decentralize its foreign trade system to integrate itself into the international trading system. These efforts made China one of the world's largest exporter of goods and can explain the trade surplus in the plot.*

*Moreover, the proportion of investment in Malaysia is growing fast from 1970. A possible reason is that in the 1970s, Malaysia began to imitate the four Asian Tiger economies (South Korea, Taiwan, Hong Kong and Singapore) and committed itself to a transition from being reliant on mining and agriculture to an economy that depends more on manufacturing. The sudden decrease in investment in 1997 is probably the result of Asian financial crisis. Since 1997, net exports stand for over 20% of GDP in Malaysia. Malaysian exports became the country's primary growth engine. Malaysia now is a typical export-oriented economy.*

*Finally, the proportion of components of GDP in Spain is generally stable with government expenses gradually rising since 1970 by a total of 10%. The sudden decrease in its investment sector by 10% in 2008-2009 shows that the financial crisis also impacted Spain and made its economy plunge into a recession. The change in net export indicates that Spain managed to reverse the trade deficit which had built since 2003 and eventually attained a trade surplus in 2010.*

# Details

-   Who did you collaborate with: *Group 3 (Jiaying Chen, Yingjin He, Sabrina Seow, Kashish Solanki, Roman Vazquez Lorenzo, Maximilian Stock)*
-   Approximately how much time did you spend on this problem set: *10*
-   What, if anything, gave you the most trouble: *facet_grid needed some getting used to, but other than that it was mostly good. We find customizing legends to our exact needs always a little bit tedious.*

**Please seek out help when you need it,** and remember the [15-minute rule](https://mam2022.netlify.app/syllabus/#the-15-minute-rule){target="_blank"}. You know enough R (and have enough examples of code from class and your readings) to be able to do this. If you get stuck, ask for help from others, post a question on Slack-- and remember that I am here to help too!
